# å‰è¨€

YYText æ˜¯ä¸šç•ŒçŸ¥åå¯Œæ–‡æœ¬æ¡†æ¶ï¼ŒåŸºäº CoreText åšäº†å¤§é‡åŸºç¡€è®¾æ–½å¹¶ä¸”å®ç°äº†ä¸¤ä¸ªä¸Šå±‚è§†å›¾ç»„ä»¶ï¼šYYLabel å’Œ YYTextViewã€‚åŒå…¶å®ƒ YYKit ç»„ä»¶ä¸€æ ·ï¼ŒYYText åœ¨æ€§èƒ½æ–¹é¢è¡¨ç°ä¼˜å¼‚ï¼Œä¸”åŠŸèƒ½å‡ºå¥‡çš„å¼ºå¤§ï¼Œå¯ä»¥è¯´æ˜¯ä¸šç•Œå·…å³°ä¹‹ä½œã€‚

æèµ· YYTextï¼Œéƒ½çŸ¥é“å®ƒçš„æ ¸å¿ƒä¼˜åŒ–ç‚¹ï¼šå¼‚æ­¥ç»˜åˆ¶ï¼Œç„¶è€Œè¿™åªæ˜¯å†°å±±ä¸€è§’ï¼ŒYYText ä¸­æœ€ä¸ºå¤æ‚å’Œç¯‡å¹…æœ€å¤šçš„æ˜¯åŸºäº CoreText çš„å„ç§è®¡ç®—ï¼Œä¸å¾—ä¸è¯´ï¼Œæºç ä¸­å¤§é‡çš„è®¡ç®—å¾ˆå®¹æ˜“è®©äººçœ¼èŠ±ç¼­ä¹±ã€‚

è‹¥æƒ³æ·±å…¥ç†è§£ YYText æˆ–è€…çœ‹æ‡‚æœ¬æ–‡ï¼Œå¿…é¡»è¦äº†è§£ CoreText åŸºç¡€çŸ¥è¯†å¹¶ä¸”æœ‰è¶³å¤Ÿçš„è€å¿ƒã€‚æ¡†æ¶ä»£ç é‡éå¸¸å¤§ï¼Œæœ¬æ–‡ä¸»è¦è®²è§£æ¡†æ¶åŸºäº CoreText çš„åº•å±‚åŸºç¡€éƒ¨åˆ†ï¼Œä¸ä¼šè¿‡å¤šçš„è®²è§£ YYLabel å’Œ YYTextView çš„ç»†èŠ‚ã€‚

## ä¸€ã€æ¡†æ¶æ€»è§ˆ

**YYText GitHub** (https://github.com/ibireme/YYText)

iOS UI ç»„ä»¶å¤§éƒ½å¿…é¡»åœ¨ä¸»çº¿ç¨‹ç»˜åˆ¶ï¼Œå½“ç»˜åˆ¶å‹åŠ›è¿‡å¤§ä¼šé€ æˆç•Œé¢å¡é¡¿ï¼Œå¾—ç›Šäºå¤šçº¿ç¨‹æŠ€æœ¯ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å¼‚æ­¥çº¿ç¨‹ç»˜åˆ¶å›¾å½¢ä»è€Œå‡è½»ä¸»çº¿ç¨‹å‹åŠ›ã€‚

YYText æ ¸å¿ƒæ€è·¯ï¼šåœ¨å¼‚æ­¥çº¿ç¨‹åˆ›å»ºå›¾å½¢ä¸Šä¸‹æ–‡ï¼Œç„¶ååˆ©ç”¨ CoreText ç»˜åˆ¶å¯Œæ–‡æœ¬ï¼Œåˆ©ç”¨ CoreGraphics ç»˜åˆ¶å›¾ç‰‡ã€é˜´å½±ã€è¾¹æ¡†ç­‰ï¼Œæœ€åå°†ç»˜åˆ¶å®Œæˆçš„ä½å›¾æ”¾åˆ°ä¸»çº¿ç¨‹æ˜¾ç¤ºã€‚

![](https://upload-images.jianshu.io/upload_images/2909132-19f53ae874a301c6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

æ­¥éª¤çœ‹èµ·æ¥å¾ˆç®€å•ï¼Œæºç ä¸­æ¶‰åŠåˆ° CoreText å’Œ CoreGraphics çš„ç»˜åˆ¶æ—¶éœ€è¦å¤§é‡çš„ä»£ç æ¥è®¡ç®—ä½ç½®ï¼Œè¿™ä¹Ÿæ˜¯æœ¬æ–‡çš„é‡ç‚¹ä¹‹ä¸€ã€‚ä¸ºäº†ç®€æ´æ˜“æ‡‚ï¼Œç¬”è€…ä¼šç•¥è¿‡ä¸€äº›æŠ€æœ¯ç»†èŠ‚ï¼Œæ¯”å¦‚çºµå‘æ–‡æœ¬å¸ƒå±€é€»è¾‘ï¼Œä¸€äº›å¥‡æ€ªçš„ BUG ä¿®å¤ä»£ç ã€‚

å¸Œæœ›è¯»è€…æœ‹å‹ä¼˜å…ˆäº†è§£ CoreText åŸºç¡€ ([CoreText å®˜æ–¹ä»‹ç»](https://developer.apple.com/library/archive/documentation/StringsTextFonts/Conceptual/CoreText_Programming/Introduction/Introduction.html#//apple_ref/doc/uid/TP40005533-CH1-SW1))ï¼Œè¿™é‡Œæ”¾ä¸Šä¸¤ä¸ªç»“æ„å›¾ä¾¿äºç†è§£ï¼ˆå›¾ä¼šæœ‰åå·®ï¼‰ï¼š

![ç»“æ„å›¾1](https://upload-images.jianshu.io/upload_images/2909132-90372e1edca32ec8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

![ç»“æ„å›¾2](https://upload-images.jianshu.io/upload_images/2909132-2bb13095979bb8ad.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

## äºŒã€CoreText ç›¸å…³å·¥å…·ç±»

### 1ã€YYTextRunDelegate 

åœ¨å¯Œæ–‡æœ¬ä¸­æ’å…¥ key ä¸º`kCTRunDelegateAttributeName` çš„`CTRunDelegateRef`å®ä¾‹å¯ä»¥å®šåˆ¶ä¸€æ®µåŒºåŸŸçš„å¤§å°ï¼Œé€šå¸¸ä½¿ç”¨è¿™ä¸ªæ–¹å¼æ¥é¢„ç•™å‡ºä¸€æ®µç©ºç™½ï¼Œåé¢å¯ä»¥å¡«å……å›¾ç‰‡æ¥è¾¾åˆ°å›¾æ–‡æ··æ’çš„æ•ˆæœã€‚è€Œåˆ›å»º`CTRunDelegateRef`éœ€è¦ä¸€ç³»åˆ—çš„å‡½æ•°åï¼Œä½¿ç”¨ç¹çï¼Œæ¡†æ¶ä½¿ç”¨ä¸€ä¸ªç±»æ¥å°è£…ä»¥å‡å°ä½¿ç”¨æˆæœ¬ï¼š

```objc
@interface YYTextRunDelegate : NSObject <NSCopying, NSCoding>
...
@property (nonatomic) CGFloat ascent;
@property (nonatomic) CGFloat descent;
@property (nonatomic) CGFloat width;
@end


static void DeallocCallback(void *ref) {
YYTextRunDelegate *self = (__bridge_transfer YYTextRunDelegate *)(ref);
self = nil; // release
}
static CGFloat GetAscentCallback(void *ref) {
YYTextRunDelegate *self = (__bridge YYTextRunDelegate *)(ref);
return self.ascent;
}
...
@implementation YYTextRunDelegate
- (CTRunDelegateRef)CTRunDelegate CF_RETURNS_RETAINED {
CTRunDelegateCallbacks callbacks;
callbacks.dealloc = DeallocCallback;
callbacks.getAscent = GetAscentCallback;
...
return CTRunDelegateCreate(&callbacks, (__bridge_retained void *)(self.copy));
}
...
```
ä½¿ç”¨`CTRunDelegateCreate()`åˆ›å»ºä¸€ä¸ª`CTRunDelegateRef`ï¼ŒåŒæ—¶ä½¿ç”¨`__bridge_retained`è½¬ç§»å†…å­˜ç®¡ç†ï¼ŒæŒæœ‰ä¸€ä¸ª`YYTextRunDelegate`å¯¹è±¡ã€‚åœ¨è¯¥ç±»ä¸­æœ‰æ•°ä¸ªé™æ€å‡½æ•°ä½œä¸ºå›è°ƒï¼Œæ¯”å¦‚å½“å›è°ƒ`GetAscentCallback()`å‡½æ•°æ—¶ï¼Œå°†æŒæœ‰å¯¹è±¡çš„`ascent`å±æ€§ä½œä¸ºè¿”å›å€¼ã€‚

**æ³¨æ„ä¸€ï¼š**è¿™æ ·åšä¼¼ä¹å­˜åœ¨å†…å­˜ç®¡ç†é—®é¢˜ï¼Œ`CTRunDelegateRef`å®ä¾‹æŒæœ‰çš„`YYTextRunDelegate`å¯¹è±¡å¦‚ä½•é‡Šæ”¾ï¼Ÿ
ç­”æ¡ˆå°±åœ¨`CTRunDelegateRef`é‡Šæ”¾æ—¶ä¼šèµ°çš„`DeallocCallback()`å›è°ƒä¸­ï¼Œå°†å†…å­˜ç®¡ç†æƒé™è½¬ç§»ç»™ä¸€ä¸ª`YYTextRunDelegate`å±€éƒ¨å˜é‡è‡ªåŠ¨ç®¡ç†å†…å­˜ã€‚

**æ³¨æ„äºŒï¼š**å¯ä»¥çœ‹åˆ°`CTRunDelegateCreate(&callbacks, (__bridge_retained void *)(self.copy))`ä»£ç å¯¹`self`åšäº†ä¸€ä¸ª`copy`æ“ä½œ (è¯¥ç±»çš„ copy ä¸ºæ·±æ‹·è´) ï¼Œè¿™æ ·åšæ˜¯ä¸ºäº†ä»€ä¹ˆå‘¢ï¼Ÿ
å¯èƒ½ç¬¬ä¸€ååº”æ˜¯æƒ³åˆ°`CTRunDelegateRef`æŒæœ‰`self`çš„å‰¯æœ¬æ˜¯ä¸ºäº†é¿å…å¾ªç¯å¼•ç”¨ï¼Œç„¶è€Œè¯¥æ–¹æ³•å¹¶æ²¡æœ‰è®©`self`æŒæœ‰`CTRunDelegateCreate()`åçš„å®ä¾‹ï¼Œæ‰€ä»¥ä¹Ÿä¸å­˜åœ¨å¾ªç¯å¼•ç”¨é—®é¢˜ã€‚
å®é™…ä¸Šè¿™é‡Œåº”è¯¥åªæ˜¯åˆ›å»ºä¸€ä¸ªå‰¯æœ¬ï¼Œå½“è¯¥æ–¹æ³•è¿”å›åä¿è¯é…ç½®æ•°æ®çš„å®‰å…¨æ€§ (é¿å…è¢«å¤–éƒ¨æ„å¤–æ›´æ”¹)ã€‚

### 2ã€YYTextLine

åˆ›å»ºä¸€ä¸ªå¯Œæ–‡æœ¬ï¼Œå¯ä»¥æ‹¿åˆ°`CTLineRef`å’Œ`CTRunRef`ä»¥åŠä¸€äº›ç»“æ„æ•°æ® (æ¯”å¦‚`ascent descent`ç­‰)ï¼Œ`CTRunRef`åŒ…å«çš„æ•°æ®å†…å®¹å¹¶ä¸æ˜¯å¾ˆå¤šï¼Œæ‰€ä»¥æ¡†æ¶æ²¡æœ‰ä¸“é—¨åšä¸€ä¸ªç±»æ¥åŒ…è£…å®ƒã€‚ä½¿ç”¨`YYTextLine`æ¥åŒ…è£…`CTLineRef`è®¡ç®—ä¿å­˜ä¸€äº›æ•°æ®ä¾¿äºåé¢çš„è®¡ç®—ï¼Œæ¯”å¦‚ä½¿ç”¨`CTLineGetTypographicBounds(...);`æ–¹æ³•æ¥æ‹¿åˆ°`ascent descent leading`ç­‰ã€‚

#### è®¡ç®— line ä½ç½®å’Œå¤§å°

```objc
_bounds = CGRectMake(_position.x, _position.y - _ascent, _lineWidth, _ascent + _descent);
_bounds.origin.x += _firstGlyphPos;
```
`_position`æ˜¯æŒ‡ line çš„`origin`ç‚¹ä½äº`context`ä¸Šä¸‹æ–‡çš„åæ ‡è½¬æ¢ä¸º`UIKit`åæ ‡ç³»çš„å€¼ï¼Œé‚£ä¹ˆç»“åˆä¸Šé¢çš„ç»“æ„å›¾2åˆ†æï¼š`_position.y - _ascent`å°±æ˜¯ line çš„æœ€å°`y`å€¼ï¼Œ`_ascent + _descent`å°±æ˜¯ line é«˜åº¦ï¼ˆæ²¡æœ‰ç®—ä¸Šè¡Œé—´è· leadingï¼‰ã€‚

è¿™é‡Œæœ€å°`x`å€¼åŠ äº†ä¸€ä¸ª`_firstGlyphPos`ï¼Œå®ƒæ˜¯å½“å‰ line ç¬¬ä¸€ä¸ª run ç›¸å¯¹äº line çš„åç§»ï¼Œé€šè¿‡`CTRunGetPositions(...);`ç®—å‡ºï¼Œå¯èƒ½æœ‰ä¸€ç§åœºæ™¯ï¼Œline çš„`origin`ä½ç½®ä¸ç¬¬ä¸€ä¸ª run çš„ä½ç½®æœ‰åç§»ï¼ˆç¬”è€…å¹¶æ²¡æœ‰æ¨¡æ‹Ÿå‡ºè¿™ç§æƒ…å†µï¼‰ã€‚

#### æ‰¾å‡ºæ‰€æœ‰çš„å ä½ run

å®é™…ä¸Šè¿™å°±æ˜¯æ‰¾å‡ºä¹‹å‰è¯´çš„`CTRunDelegateRef `ï¼Œæ¡†æ¶æ¯ä¸€ä¸ª`CTRunDelegateRef `éƒ½å¯¹åº”äº†ä¸€ä¸ª`YYTextAttachment`ï¼Œå®ƒè¡¨ç¤ºä¸€ä¸ªé™„ä»¶ï¼ˆå›¾ç‰‡ã€UIViewã€CALayerï¼‰ï¼Œå…·ä½“å®ç°åé¢ä¼šå•ç‹¬è®²ã€‚è¿™é‡Œåªéœ€è¦çŸ¥é“åŸºæœ¬åŸç†å°±æ˜¯ç”¨`CTRunDelegateRef`å ä½ï¼Œç”¨`YYTextAttachment`å¡«å……ã€‚

å½“éå† line é‡Œé¢çš„ run æ—¶ï¼Œè‹¥è¯¥ run åŒ…å«äº†`YYTextAttachment`è¯´æ˜è¿™æ˜¯å ä½ runï¼Œé‚£ä¹ˆè‡³å…³é‡è¦çš„ä¸€æ­¥æ˜¯è®¡ç®—è¿™ä¸ª run çš„ä½ç½®å’Œå¤§å°ï¼ˆä¾¿äºåé¢å°†é™„ä»¶å¡«å……åˆ°æ­£ç¡®ä½ç½®ï¼‰ã€‚

```objc
runPosition.x += _position.x;
runPosition.y = _position.y - runPosition.y;
runTypoBounds = CGRectMake(runPosition.x, runPosition.y - ascent, runWidth, ascent + descent);
```

`_position`ä¸Šé¢å·²ç»è¯´æ˜äº†æ„ä¹‰ï¼Œ`runPosition`æ˜¯å½“å‰ run ç›¸å¯¹äºå½“å‰ line `origin`çš„åç§»ï¼Œé‚£ä¹ˆ`runPosition.x + _position.x`è¡¨ç¤ºäº† run ç›¸å¯¹äºå›¾å½¢ä¸Šä¸‹æ–‡çš„`x`æ–¹å‘ä½ç½®ï¼Œåé¢åŒç†ã€‚

æœ€ç»ˆï¼Œå°†è¿™ä¸ª`YYTextAttachment `é™„ä»¶å¯¹è±¡å’Œ run ä½ç½®å¤§å°ä¿¡æ¯ç¼“å­˜èµ·æ¥ï¼ˆåé¢ä¼šä¸“é—¨åˆ†æå®ç°é€»è¾‘ï¼‰ã€‚

### 3ã€YYTextContainer

åˆ›å»º`CTFrameRef`ä½¿ç”¨`CTFramesetterCreateFrame(...)`æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•éœ€è¦ä¸€ä¸ª`CGPathRef `å‚æ•°ï¼Œä¸ºäº†ä½¿ç”¨ç®€ä¾¿ï¼Œæ¡†æ¶æŠ½è±¡äº†ä¸€ä¸ª`YYTextContainer `ç±»é‡ç‚¹å±æ€§å¦‚ä¸‹ï¼š

```objc
@property CGSize size;
@property UIEdgeInsets insets;
@property (nullable, copy) UIBezierPath *path;
@property (nullable, copy) NSArray<UIBezierPath *> *exclusionPaths;
```
ä½¿ç”¨è€…å¯ä»¥ç®€å•çš„ä½¿ç”¨`CGSize `æ¥åˆ¶å®šå¯Œæ–‡æœ¬çš„å¤§å°ï¼Œä¹Ÿå¯ä»¥ç”¨å†…å­˜è‡ªåŠ¨ç®¡ç†åŠŸèƒ½å¼ºå¤§çš„`UIBezierPath `æ¥åˆ¶å®šè·¯å¾„ï¼ŒåŒæ—¶åŒ…å«ä¸€ä¸ª`exclusionPaths `æ’é™¤è·¯å¾„ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  <------- container
â”‚                             â”‚
â”‚    asdfasdfasdfasdfasdfa   <------------ container insets
â”‚    asdfasdfa   asdfasdfa    â”‚
â”‚    asdfas         asdasd    â”‚
â”‚    asdfa        <----------------------- container exclusion path
â”‚    asdfas         adfasd    â”‚
â”‚    asdfasdfa   asdfasdfa    â”‚
â”‚    asdfasdfasdfasdfasdfa    â”‚
â”‚                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

CoreText æ˜¯æ”¯æŒé•‚ç©ºæ•ˆæœçš„ï¼Œå°±æ˜¯ç”±è¿™ä¸ª exclusion path æ§åˆ¶ã€‚è¯¥ç±»çš„å±æ€§è®¿é—®éƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œè¿˜åšäº†ä¸€äº›ç²¾è‡´çš„å®¹é”™ã€‚

## ä¸‰ã€YYTextLayout æ ¸å¿ƒè®¡ç®—ç±»

`YYTextLayout`åŒ…å«äº†å¸ƒå±€ä¸€ä¸ªå¯Œæ–‡æœ¬å‡ ä¹æ‰€æœ‰çš„ä¿¡æ¯ï¼ŒåŒæ—¶è¿˜å°†ä¼—å¤šçš„ç»˜åˆ¶ç›¸å…³ C ä»£ç æ”¾åœ¨äº†è¿™ä¸ªæ–‡ä»¶é‡Œé¢ï¼Œæ‰€ä»¥è¿™ä¸ªæ–‡ä»¶éå¸¸åºå¤§ã€‚æˆ‘ä»¬å…ˆä¸ç®¡è¿™äº›ç»˜åˆ¶ä»£ç ï¼Œ`YYTextLayout`ä¸»è¦çš„ä½œç”¨æ˜¯è®¡ç®—å„ç§æ•°æ®ï¼Œä¸ºåé¢çš„ç»˜åˆ¶åšå‡†å¤‡ã€‚

æ ¸å¿ƒè®¡ç®—åœ¨`+ (YYTextLayout *)layoutWithContainer:(YYTextContainer *)container text:(NSAttributedString *)text range:(NSRange)range;`åˆå§‹åŒ–æ–¹æ³•ä¸­ï¼Œè¿™ä¸ªæ–¹æ³•ä¸ºåé¢çš„å„ç§æŸ¥è¯¢è®¡ç®—æ‰“ä¸‹äº†æ•°æ®åŸºç¡€ï¼Œæ¥ä¸‹æ¥å°±åˆ†æä¸€ä¸‹è¿™ä¸ªè¶…è¿‡ 500 è¡Œçš„åˆå§‹åŒ–æ–¹æ³•åšäº†äº›ä»€ä¹ˆã€‚

### 1ã€è®¡ç®—ç»˜åˆ¶è·¯å¾„å’Œè·¯å¾„çš„ä½ç½®çŸ©å½¢

åŸºäº`YYTextContainer`å¯¹è±¡è®¡ç®—å¾—åˆ°`CGPathRef`æ˜¯ä¸»è¦é€»è¾‘ï¼Œä¸ºäº†é¿å…çŸ©é˜µå±æ€§å‡ºç°è´Ÿå€¼ï¼Œä½¿ç”¨`CGRectStandardize(...)`æ¥çŸ«æ­£ã€‚ç”±äº UIKit å’Œ CoreText åæ ‡ç³»çš„å·®åˆ«ï¼Œæœ€ç»ˆå¾—åˆ°çš„çŸ©é˜µè¦å…ˆåšä¸€ä¸ªåæ ‡ç³»ç¿»è½¬ï¼š

```objc
rect = CGRectApplyAffineTransform(rect, CGAffineTransformMakeScale(1, -1));
cgPath = CGPathCreateWithRect(rect, NULL);
```

æˆ–è€…

```objc
CGAffineTransform trans = CGAffineTransformMakeScale(1, -1);
CGMutablePathRef transPath = CGPathCreateMutableCopyByTransformingPath(path, &trans);
```

å®ƒä»¬é“ç†æ˜¯ä¸€æ ·çš„ï¼Œéƒ½æ˜¯æ²¿ç€ x è½´ç¿»è½¬åæ ‡ç³» 180Â°ï¼Œå¯èƒ½æœ‰äººæœ‰ç–‘é—®ï¼ŒUIKit è½¬æ¢ä¸º CoreText åæ ‡ç³»ä¸æ˜¯é™¤äº†ç¿»è½¬ 180Â°ï¼Œè¿˜è¦ç§»åŠ¨ä¸€ä¸ªç»˜åˆ¶åŒºåŸŸé«˜åº¦ä¹ˆï¼Ÿç¡®å®è¿™é‡Œå°‘åšäº†ä¸€ä¸ªæ“ä½œï¼Œé‚£æ˜¯å› ä¸ºæ¡†æ¶æ˜¯ä½¿ç”¨`CTRunDraw(...)`éå†ç»˜åˆ¶ runï¼Œåœ¨ç»˜åˆ¶ run ä¹‹å‰ä¼šç”¨`CGContextSetTextPosition(...)`æŒ‡å®šä½ç½®ï¼ˆè¿™ä¸ªä½ç½®æ˜¯ line ç›¸å¯¹äºç»˜åˆ¶åŒºåŸŸè®¡ç®—çš„ï¼‰ï¼Œæ‰€ä»¥è¿™ä¸ªåœ°æ–¹çš„ y åæ ‡æ˜¯å¦æ­£ç¡®å·²ç»æ²¡æœ‰æ„ä¹‰äº†ã€‚

ç»˜åˆ¶è·¯å¾„çš„çŸ©å½¢å¤§å°ä½ç½®`pathBox`çš„è®¡ç®—ï¼š
![](https://upload-images.jianshu.io/upload_images/2909132-24fc64fb2d357b99.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)          
æ¯”å¦‚è¿™ç§æƒ…å†µï¼Œ`pathBox =  (CGRect){50, 50, 100, 100}`ï¼Œå¯æƒ³è€ŒçŸ¥`pathBox `æŒ‡çš„å°±æ˜¯çœŸæ­£ç»˜åˆ¶åŒºåŸŸç›¸å¯¹äºç»˜åˆ¶ä¸Šä¸‹æ–‡çš„ä½ç½®å’Œå¤§å°ï¼Œè¿™ä¸ªæ•°æ®éå¸¸æœ‰ç”¨ï¼Œæ„å‘³ç€åé¢è®¡ç®— line å’Œ run çš„ä½ç½®æ—¶ï¼Œéƒ½è¦åŠ ä¸Š `cgPathBox.origin`åç§»ï¼Œæ‰èƒ½çœŸæ­£è¡¨ç¤º line å’Œ run ç›¸å¯¹äºç»˜åˆ¶ä¸Šä¸‹æ–‡çš„ä½ç½®ï¼ˆæ¯”å¦‚ line çš„`origin`æ˜¯ç›¸å¯¹äºç»˜åˆ¶åŒºåŸŸçš„ä¸€ä¸ªç‚¹ï¼Œè€Œä¸æ˜¯ç›¸å¯¹äºç»˜åˆ¶ä¸Šä¸‹æ–‡ï¼‰ã€‚

### 2ã€åˆå§‹åŒ– CTFramesetterRef å’Œ CTFrameRef

è¿™ä¸€æ­¥å¾ˆç®€å•ï¼Œåˆ©ç”¨ä¸¤ä¸ªå‡½æ•°å°±æå®šï¼š`CTFramesetterCreateWithAttributedString(...) CTFramesetterCreateFrame(...)`ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯æ¡†æ¶æ”¯æŒäº†å‡ ä¸ª CTFrameRef çš„å±æ€§ï¼Œæ¯”å¦‚`kCTFramePathWidthAttributeName`ï¼Œè¿™äº›å±æ€§åŒæ ·æ˜¯é€šè¿‡`YYTextContainer `é…ç½®çš„ã€‚

### 3ã€è®¡ç®— line æ€» frame å’Œè¡Œæ•°

å‰é¢å·²ç»åˆ›å»ºäº†ä¸€ä¸ªå¯Œæ–‡æœ¬`CTFrameRef `ï¼Œé‚£ä¹ˆè¿™é‡Œåªéœ€è¦éå†æ‰€æœ‰çš„ line åšè®¡ç®—ï¼Œå¯ä»¥çœ‹åˆ°å¦‚ä¸‹ä»£ç è·å–æ¯ä¸€ä¸ª line çš„ä½ç½®å¤§å°ï¼š

```objc
// CoreText coordinate system
CGPoint ctLineOrigin = lineOrigins[i]; 
// UIKit coordinate system
CGPoint position;
position.x = cgPathBox.origin.x + ctLineOrigin.x;
position.y = cgPathBox.size.height + cgPathBox.origin.y - ctLineOrigin.y;

YYTextLine *line = [YYTextLine lineWithCTLine:ctLine position:position vertical:isVerticalForm];
CGRect rect = line.bounds;
```

`lineOrigins `æ˜¯é€šè¿‡`CTFrameGetLineOrigins(...)`å¾—åˆ°çš„ï¼Œæ‰€ä»¥éœ€è¦è½¬æ¢ä¸º UIKit åæ ‡ç³»æ–¹ä¾¿è®¡ç®—ã€‚å¯ä»¥çœ‹åˆ°è½¬æ¢æ—¶åšäº†ä¸€ä¸ª`cgPathBox.origin`çš„åç§»ï¼Œè¿™å°±æ˜¯ä¹‹å‰è®¡ç®—çš„å®é™…ç»˜åˆ¶çŸ©å½¢çš„åç§»ï¼Œä»¥æ­¤å¾—åˆ°çš„`position`å°±æ˜¯ç›¸å¯¹äºå›¾å½¢ä¸Šä¸‹æ–‡çš„ç‚¹äº†ï¼Œç„¶ååˆ©ç”¨è¿™ä¸ªç‚¹åˆå§‹åŒ–`YYTextLine`ï¼Œå‰é¢è®²äº†`YYTextLine`çš„å†…éƒ¨å®ç°ï¼Œè¿™é‡Œå°±ç›´æ¥å¾—åˆ°äº†å½“å‰ line çš„ä½ç½®å’Œå¤§å°ï¼š`rect`ã€‚

ç„¶åï¼Œåˆ©ç”¨`CGRectUnion(...)`å‡½æ•°å°†æ¯ä¸€ä¸ª line çš„`rect`åˆå¹¶èµ·æ¥ï¼Œå¾—åˆ°ä¸€ä¸ªåŒ…å«æ‰€æœ‰ line çš„æœ€å°ä½ç½®çŸ©å½¢`textBoundingRect`ã€‚

#### è®¡ç®— line çš„è¡Œæ•°

å¹¶ä¸æ˜¯ä¸€ä¸ª line å°±å æœ‰ä¸€è¡Œï¼Œå½“æœ‰æ’é™¤è·¯å¾„æ—¶ï¼Œä¸€è¡Œå¯èƒ½æœ‰ä¸¤ä¸ª lineï¼š

![](https://upload-images.jianshu.io/upload_images/2909132-00caa33b292d8329.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

æ‰€ä»¥ï¼Œéœ€è¦è®¡ç®—æ¯ä¸ª line æ‰€åœ¨çš„è¡Œï¼Œä¾¿äºä¸ºåç»­çš„å¾ˆå¤šè®¡ç®—æä¾›åŸºç¡€ï¼Œæ¯”å¦‚æœ€å¤§è¡Œé™åˆ¶ã€‚

![](https://upload-images.jianshu.io/upload_images/2909132-2dbd26fff2828ded.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

å½“å½“å‰ line çš„é«˜åº¦å¤§äº last line çš„é«˜åº¦æ—¶ï¼Œè‹¥å½“å‰ line çš„ y0 åœ¨ baseline ä»¥ä¸Šï¼Œy1 åœ¨ baseline ä»¥ä¸‹ï¼Œå°±è¯´æ˜æ²¡æœ‰æ¢è¡Œã€‚

![](https://upload-images.jianshu.io/upload_images/2909132-1fd06a162d69e37e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

å½“å½“å‰ line çš„é«˜åº¦å°äº last line çš„é«˜åº¦æ—¶ï¼Œè‹¥ last line çš„ y0 åœ¨ baseline ä»¥ä¸Šï¼Œy1 åœ¨ baseline ä»¥ä¸‹ï¼Œå°±è¯´æ˜æ²¡æœ‰æ¢è¡Œã€‚

### 4ã€è·å–è¡Œä¸Šä¸‹è¾¹ç•Œæ•°ç»„

```objc
typedef struct {
CGFloat head;
CGFloat foot;
} YYRowEdge;
```

å£°æ˜äº†ä¸€ä¸ª`YYRowEdge *lineRowsEdge = NULL;`æ•°ç»„ï¼Œ`YYRowEdge `è¡¨ç¤ºæ¯ä¸€è¡Œçš„ä¸Šä¸‹è¾¹ç•Œã€‚è®¡ç®—é€»è¾‘å¤§è‡´æ˜¯è¿™æ ·çš„ï¼š

éå†æ‰€æœ‰ lineï¼Œå½“å½“å‰ line å’Œ last line ä¸ºåŒä¸€è¡Œæ—¶ï¼Œå– line å’Œ last line å…±åŒçš„æœ€å¤§ä¸Šä¸‹è¾¹ç•Œï¼š

```objc
lastHead = MIN(lastHead, rect.origin.y);
lastFoot = MAX(lastFoot, rect.origin.y + rect.size.height);
```

å½“å½“å‰ line å’Œ last line ä¸ºä¸åŒè¡Œæ—¶ï¼Œå–å½“å‰ line çš„ä¸Šä¸‹è¾¹ç•Œï¼š

```objc
lastHead = rect.origin.y;
lastFoot = lastHead + rect.size.height;
```

æœ€ç»ˆçš„ç»“æœå¯èƒ½æ˜¯è¿™æ ·çš„ï¼š

![](https://upload-images.jianshu.io/upload_images/2909132-6910ffb31cc7eb9a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

`foot1`å’Œ`head2`ä¹‹é—´ä¼šå­˜åœ¨ä¸€ä¸ªé—´éš™ï¼Œè¿™ä¸ªé—´éš™å°±æ˜¯è¡Œé—´è·ï¼Œæ¡†æ¶çš„å¤„ç†æ˜¯å°†è¿™ä¸ªé—´éš™å‡åˆ†ï¼š
![](https://upload-images.jianshu.io/upload_images/2909132-d454692a48717fa0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

### 5ã€è®¡ç®—ç»˜åˆ¶åŒºåŸŸæ€»å¤§å°
ä¸Šé¢å·²ç»è®¡ç®—äº†ç»˜åˆ¶è·¯å¾„çš„ä½ç½®çŸ©å½¢`pathBox`ï¼Œè¿™åªæ˜¯å®é™…ç»˜åˆ¶åŒºåŸŸçš„å¤§å°ï¼Œä¸šåŠ¡ä¸­è‹¥è®¾ç½®äº†`YYTextContainer`çš„çº¿å®½æˆ–è€…è¾¹è·ï¼Œé‚£ä¹ˆå®é™…ä¸šåŠ¡éœ€è¦çš„ç»˜åˆ¶åŒºåŸŸæ€»å¤§å°ä¼šæ›´å¤§ï¼š

![](https://upload-images.jianshu.io/upload_images/2909132-5a1fc3e2a16c6a64.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

å›¾ä¸­è“è‰²å¡«å……åŒºåŸŸå³ä¸ºå®é™…ç»˜åˆ¶åŒºåŸŸ`pathBox`ï¼Œç»˜åˆ¶åŒºåŸŸæ€»å¤§å°åº”è¯¥æ˜¯è“è‰²è¾¹æ¡†æ‰€è¦†ç›–çš„èŒƒå›´ï¼ˆè¯·å¿½ç•¥çº¿ä¸çº¿ä¹‹é—´çš„å°ç¼éš™ï¼‰ã€‚å€ŸåŠ©`CGRectInset(...) UIEdgeInsetsInsetRect(...)`ç­‰å‡½æ•°èƒ½è½»æ˜“çš„è®¡ç®—å‡ºæ¥ï¼ŒåŒæ ·çš„éœ€è¦ç”¨`CGRectStandardize(...)`çº æ­£è´Ÿå€¼ã€‚

### 6ã€line æˆªæ–­

å½“å¯Œæ–‡æœ¬è¶…è¿‡é™åˆ¶æ—¶ï¼Œå¯èƒ½éœ€è¦å¯¹æœ€åä¸€è¡Œå¯æ˜¾ç¤ºçš„è¡Œæœ«å°¾åšä¸€ä¸ªçœç•¥å·ï¼š`aaaa...`ã€‚

é¦–å…ˆæœ‰ä¸€ä¸ª`NSAttributedString *truncationToken;`ï¼Œè¿™ä¸ª token å¯ä»¥è‡ªå®šä¹‰ï¼Œæ¡†æ¶ä¹Ÿæœ‰é»˜è®¤çš„ï¼Œå°±æ˜¯ä¸€ä¸ª`...`çœç•¥å·ï¼Œç„¶åå°†è¿™ä¸ª`truncationToken`æ‹¼æ¥åˆ°æœ€åä¸€ä¸ª`line`ï¼š

```objc
NSMutableAttributedString *lastLineText = [text attributedSubstringFromRange:lastLine.range].mutableCopy;
[lastLineText appendAttributedString:truncationToken];
```

å½“ç„¶ï¼Œè¿™æ ·`lastLineText`è‚¯å®šä¼šè¶…è¿‡ç»˜åˆ¶åŒºåŸŸçš„èŒƒå›´ï¼Œæ‰€ä»¥è¦ä½¿ç”¨ç³»ç»Ÿæä¾›çš„æ–¹æ³•`CTLineCreateTruncatedLine(...)`æ¥åˆ›å»ºè‡ªåŠ¨è®¡ç®—çš„æˆªæ–­ lineï¼Œè¯¥æ–¹æ³•è¿”å›ä¸€ä¸ª`CTLineRef`ï¼Œè¿™é‡Œè½¬æ¢ä¸º`YYTextLine`å¹¶ä¸”ä½œä¸º`YYTextLayout`çš„ä¸€ä¸ªå±æ€§`truncatedLine`ã€‚

è¿™ä¹Ÿå°±æ„å‘³ç€ï¼ŒYYText çš„æˆªæ–­æ€»æ˜¯åœ¨å¯Œæ–‡æœ¬æœ€åçš„ï¼Œä¸”åªæœ‰ä¸€ä¸ªã€‚

### 7ã€ç¼“å­˜å„ç§ BOOL å€¼

éå†å¯Œæ–‡æœ¬å¯¹è±¡ï¼Œç¼“å­˜ä¸€ç³»åˆ—çš„ BOOL å€¼ï¼š

```objc
void (^block)(NSDictionary *attrs, NSRange range, BOOL *stop) = ^(NSDictionary *attrs, NSRange range, BOOL *stop) {
if (attrs[YYTextHighlightAttributeName]) layout.containsHighlight = YES;
if (attrs[YYTextBlockBorderAttributeName]) layout.needDrawBlockBorder = YES;
if (attrs[YYTextBackgroundBorderAttributeName]) layout.needDrawBackgroundBorder = YES;
if (attrs[YYTextShadowAttributeName] || attrs[NSShadowAttributeName]) layout.needDrawShadow = YES;
...
};
[layout.text enumerateAttributesInRange:visibleRange options:NSAttributedStringEnumerationLongestEffectiveRangeNotRequired usingBlock:block];
```

å¯ä»¥çŒœæµ‹ï¼Œ`YYTextBlockBorderAttributeName `ç­‰å°±æ˜¯ YYText å®šåˆ¶çš„å¯Œæ–‡æœ¬å±æ€§ï¼Œåœ¨åˆå§‹åŒ–`YYTextLayout`æ—¶å°±å°†å¯Œæ–‡æœ¬ä¸­æ˜¯å¦åŒ…å«è‡ªå®šä¹‰ key ç¼“å­˜èµ·æ¥ã€‚

æƒ³è±¡ä¸€ä¸‹ï¼Œè‹¥æ­¤å¤„ä¸ä½¿ç”¨è¿™äº› BOOL å€¼ï¼Œé‚£ä¹ˆåœ¨ç»˜åˆ¶çš„æ—¶å€™æ¡†æ¶ä¹Ÿéœ€è¦å»éå†æŸ¥æ‰¾æ˜¯å¦æœ‰è‡ªå®šä¹‰çš„ keyï¼Œè‹¥æœ‰å†æ‰§è¡Œè‡ªå®šä¹‰çš„ç»˜åˆ¶é€»è¾‘ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™ä¸ªéå†æ˜¯å¿…é¡»è¦åšçš„ï¼Œè¦ä¹ˆåœ¨åˆå§‹åŒ–æ—¶åšï¼Œè¦ä¹ˆæ˜¯ç»˜åˆ¶çš„æ—¶å€™åšã€‚

æŒ‰ç…§æ¡†æ¶çš„è®¾å®šï¼Œåˆå§‹åŒ–`YYTextLayout `å’Œç»˜åˆ¶éƒ½å¯ä»¥åœ¨ä¸»çº¿ç¨‹ä¹Ÿå¯ä»¥åœ¨å¼‚æ­¥ç»˜åˆ¶æ‰§è¡Œï¼Œæ‰€ä»¥è¿™é‡Œçš„ç›®çš„ä¸»è¦ä¸æ˜¯ä¸ºäº†å°†è¿™ä¸ªéå†é€»è¾‘æ”¾å…¥å¼‚æ­¥çº¿ç¨‹ï¼Œè€Œæ˜¯ä¸ºäº†ç¼“å­˜ã€‚

åˆå§‹åŒ–`YYTextLayout `æ—¶ç¼“å­˜è¿™äº› BOOL å€¼è¿‡åï¼ŒäºŒæ¬¡ç»˜åˆ¶å°±ä¸éœ€è¦å†éå†äº†ï¼Œä»¥æ­¤è¾¾åˆ°ä¼˜åŒ–æ€§èƒ½çš„ç›®çš„ã€‚

### 8ã€åˆå¹¶æ‰€æœ‰çš„é™„ä»¶

å‰é¢æœ‰è®²åˆ°ï¼Œ`YYTextLine`åˆå§‹åŒ–æ—¶ä¼šå°†æ‰€æœ‰çš„é™„ä»¶åŠå…¶ç›¸å…³ä½ç½®ä¿¡æ¯è£…åˆ°æ•°ç»„é‡Œé¢ï¼Œé‚£ä¹ˆè¿™é‡Œéå†æ‰€æœ‰çš„ line å°†é™„ä»¶ç›¸å…³æ•°ç»„åˆå¹¶åˆ°ä¸€èµ·ï¼Œé‚£ä¹ˆä¹‹åçš„ç»˜åˆ¶å°±ä¸éœ€è¦å†å»éå† line è·å–é™„ä»¶äº†ã€‚

### 9ã€å°ç»“

é™¤å¼€`YYTextLayout`åˆå§‹åŒ–æ–¹æ³•ï¼Œè¿˜æœ‰åœ¨`#pragma mark - Query`æ ‡è®°ä¸‹çš„ä¸€ç³»åˆ—æŸ¥è¯¢æ–¹æ³•ï¼Œè¿™äº›æŸ¥è¯¢æ–¹æ³•éƒ½æ˜¯åŸºäºä¸Šé¢çš„åˆå§‹åŒ–è®¡ç®—æ•°æ®ã€‚è‡³äº`#pragma mark - Draw`æ ‡è®°ä¸‹çš„ç»˜åˆ¶ç›¸å…³æ–¹æ³•åé¢å†è¯´ã€‚

`YYTextLayout`åˆå§‹åŒ–æ–¹æ³•éå¸¸çš„é•¿ï¼Œç¬”è€…è¯•å›¾å°†è¿™ä¸ªæ–¹æ³•åˆ†è§£ä¸€ä¸‹ï¼Œå‘ç°è¿™æ ·ä¼šæ›´å¤æ‚ã€‚åŸå› æ˜¯è¿™ä¸ªåˆå§‹åŒ–æ–¹æ³•é‡Œé¢åŒ…å«äº†ä¼—å¤šçš„éœ€è¦æ‰‹åŠ¨ç®¡ç†çš„å†…å­˜ï¼Œæ¯”å¦‚`CGPathRef CTFramesetterRef CTFrameRef`ç­‰ã€‚

å¯èƒ½æœ‰äººä¼šè¯´ï¼Œå“ªä¸ªåœ°æ–¹éœ€è¦å¼•ç”¨è®¡æ•°å‡ä¸€ï¼Œæ‰‹åŠ¨`release`ä¸å°±è¡Œäº†ï¼Ÿ

ä½†æ˜¯å®é™…æƒ…å†µæ›´åŠ å¤æ‚ï¼Œå› ä¸ºæ•´ä¸ªåˆå§‹åŒ–è¿‡ç¨‹éšæ—¶å¯èƒ½ä¼šè¢«ä¸­æ–­ã€‚æ¯”å¦‚`calloc(...)`å¼€è¾Ÿå†…å­˜å¯èƒ½ä¼šå¤±è´¥ï¼Œ`CGPathCreateMutableCopy(...)`åˆ›å»ºè·¯å¾„å¯èƒ½ä¼šå¤±è´¥ï¼Œæ‰€ä»¥ï¼Œåœ¨ä»»ä½•æƒ…å†µå¤±è´¥éœ€è¦ä¸­æ–­åˆå§‹åŒ–æ—¶ï¼Œå¤§æ¦‚ä¼šå¦‚ä¸‹å†™ï¼š

```objc
if (failed) {
CFRelease(...);
free(...);
...
return nil;
}
```

è€Œä¸”è¿™ä¸ªåœ°æ–¹ä½ å¿…é¡»è¦å°†å‰é¢æ‰€æœ‰æ‰‹åŠ¨ç®¡ç†çš„å†…å­˜é‡Šæ”¾æ‰ï¼Œå½“è¿™ä¸ªä»£ç è¿‡å¤šçš„æ—¶å€™ï¼Œå¯èƒ½ä¼šè®©ä½ ç–¯æ‰ã€‚

æ‰€ä»¥ä½œè€…ç”¨äº†ä¸€ä¸ªå¾ˆå·§çš„æ–¹æ³•ï¼Œä½¿ç”¨`goto`ï¼š

```objc
fail:
if (cgPath) CFRelease(cgPath);
if (lineOrigins) free(lineOrigins);
...
return nil;
```
é‚£ä¹ˆï¼Œå½“æŸä¸ªç¯èŠ‚å¤±è´¥æ—¶ï¼Œç›´æ¥è¿™ä¹ˆå†™ï¼š
```
if (failed) {
goto fail;
}
```

è¿™ä¸ªåœºæ™¯ä¸‹ï¼Œ`goto`çš„ä½¿ç”¨ç¡®å®éå¸¸é€‚åˆã€‚

## å››ã€è‡ªå®šä¹‰å¯Œæ–‡æœ¬å±æ€§

å‰é¢æœ‰æåˆ° YYText å®šåˆ¶çš„å¯Œæ–‡æœ¬å±æ€§ï¼Œ

æˆ‘ä»¬çŸ¥é“ï¼Œ`NSMutableAttributedString`å¯¹è±¡ä½¿ç”¨`addAttribute:value:range:`ç­‰ä¸€ç³»åˆ—æ–¹æ³•å¯ä»¥æ·»åŠ å¯Œæ–‡æœ¬æ•ˆæœï¼Œè¿™äº›æ•ˆæœæœ‰ä¸‰ä¸ªè¦ç´ ï¼šåå­— (key)ã€å€¼ (value)ã€èŒƒå›´ã€‚YYText ä¹Ÿæ‹“å±•äº†ä¸€äº›è‡ªå·±çš„åå­— (YYTextAttribute æ–‡ä»¶)ï¼š

```objc
UIKIT_EXTERN NSString *const YYTextAttachmentAttributeName;
UIKIT_EXTERN NSString *const YYTextHighlightAttributeName;
...
```

å½“ç„¶ä¸ºè¿™äº› key éƒ½åˆ›å»ºäº†å¯¹åº”çš„ value (ç±»)ï¼Œæ¯”å¦‚`YYTextHighlightAttributeName`å¯¹åº”`YYTextHighlight`ã€‚ä½†æ˜¯è¿™äº›è‡ªå®šä¹‰çš„ key CoreText æ˜¯è¯†åˆ«ä¸äº†çš„ï¼Œé‚£ä¹ˆæ¡†æ¶å†…éƒ¨æ˜¯å¦‚ä½•å¤„ç†çš„å‘¢ï¼Ÿ

```objc
NSDictionary *attrs = (id)CTRunGetAttributes(run);
id anyValue = attrs[anyKey];
if (anyValue) { ... }
```
å¾ˆç®€å•ï¼Œå®é™…ä¸Šå°±æ˜¯éå†å¯Œæ–‡æœ¬ï¼Œé€šè¿‡ä¸Šé¢è¿™æ®µä»£ç å°±èƒ½æ‰¾åˆ°æŸä¸ª run æ˜¯å¦åŒ…å«è‡ªå®šä¹‰çš„ keyï¼Œç„¶ååšç›¸åº”çš„ç»˜åˆ¶é€»è¾‘ã€‚

### 1ã€å›¾æ–‡æ··æ’å®ç°

YYText å¤§éƒ¨åˆ†çš„è‡ªå®šä¹‰å±æ€§éƒ½ç®—æ˜¯â€œè£…é¥°â€æ–‡æœ¬ï¼Œæ‰€ä»¥åªéœ€è¦ç»˜åˆ¶çš„æ—¶å€™åˆ¤æ–­æœ‰æ²¡æœ‰åŒ…å«å¯¹åº”çš„ keyï¼Œè‹¥åŒ…å«å°±åšç›¸åº”çš„ç»˜åˆ¶é€»è¾‘ã€‚ä½†æ˜¯æœ‰ä¸€ä¸ªè‡ªå®šä¹‰å±æ€§æ¯”è¾ƒç‰¹æ®Šï¼š

```objc
YYTextAttachmentAttributeName : YYTextAttachment
```

å› ä¸ºè¿™ä¸ªæ˜¯æ·»åŠ ä¸€ä¸ªé™„ä»¶ (UIImageã€UIViewã€CALayer)ï¼Œæ‰€ä»¥éœ€è¦ä¸€ä¸ªç©ºä½ï¼Œé‚£ä¹ˆè®¾ç½®è¿™ä¸ªè‡ªå®šä¹‰å±æ€§çš„æ—¶å€™è¿˜éœ€è¦è®¾ç½®ä¸€ä¸ª`CTRunDelegateRef`ï¼š

```objc
NSMutableAttributedString *atr = [[NSMutableAttributedString alloc] initWithString:YYTextAttachmentToken];

YYTextAttachment *attach = [YYTextAttachment new];
attach.content = content; // UIImageã€UIViewã€CALayer
...
[atr yy_setTextAttachment:attach range:NSMakeRange(0, atr.length)];

YYTextRunDelegate *delegate = [YYTextRunDelegate new];
...
CTRunDelegateRef delegateRef = delegate.CTRunDelegate;
[atr yy_setRunDelegate:delegateRef range:NSMakeRange(0, atr.length)];
```

#### (1) å¯¹é½æ–¹å¼

å›¾æ–‡æ··æ’æ·»åŠ å›¾ç‰‡æ—¶ï¼Œä¸šåŠ¡ä¸­å¾€å¾€æœ‰å¾ˆå¤šå¯¹é½æ–¹å¼ï¼Œå¦‚ä½•æ¥å¯¹é½é€šè¿‡è°ƒæ•´`CTRunDelegateRef `çš„`ascent descent`æ¥æ§åˆ¶ï¼Œæ¡†æ¶å¯¹å…¶æ–¹å¼æœ‰ä¸‰ç§ï¼šå±…ä¸Šï¼Œå±…ä¸‹ï¼Œå±…ä¸­ã€‚

å±…ä¸Šï¼š

![](https://upload-images.jianshu.io/upload_images/2909132-fa0d88d55964dfcc.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

è®©å ä½ run çš„`ascent`å§‹ç»ˆç­‰äºæ–‡æœ¬çš„`ascent` (è‹¥å ä½ run å¤ªçŸ®åˆ™è´´ç€ baseline) ã€‚

å±…ä¸‹ï¼š

![](https://upload-images.jianshu.io/upload_images/2909132-e73a06eee977bf9c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

è®©å ä½ run çš„`descent`å§‹ç»ˆç­‰äºæ–‡æœ¬çš„`descent ` (è‹¥å ä½ run å¤ªçŸ®åˆ™è´´ç€ baseline) ã€‚

å±…ä¸­ï¼š

![](https://upload-images.jianshu.io/upload_images/2909132-241c96962d4b26cb.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

å±…ä¸­çš„è®¡ç®—ç›¸å¯¹å¤æ‚ï¼Œéœ€è¦è®©å ä½ run çš„ä¸­ç‚¹å’Œæ–‡æœ¬çš„ä¸­ç‚¹å¯¹é½ (å¦‚å›¾)ï¼Œé‚£ä¹ˆå›¾ä¸­`yOffset + (å ä½ run çš„ height) * 0.5` å°±ç­‰äºå ä½ run çš„`ascent`  (è‹¥å ä½ run å¤ªçŸ®åˆ™è´´ç€ baseline) ã€‚

å½“ç„¶ï¼Œä¸Šé¢å›¾ä¸­çš„å›¾ç‰‡å¯ä»¥ä¸º`UIView CALayer`ã€‚åˆ°ç›®å‰ä¸ºæ­¢ï¼Œå ä½ run çš„ä½ç½®å·²ç»ç¡®å®šäº†ï¼Œæ¥ä¸‹æ¥å°±éœ€è¦æŠŠ `UIImage UIView CALayer`ç»˜åˆ¶åˆ°ç›¸åº”çš„ç©ºä½ä¸Šäº†ã€‚

#### (2) ç»˜åˆ¶é™„ä»¶

ç»˜åˆ¶çš„é€»è¾‘åœ¨`YYTextLayout`ä¸‹çš„æ–¹æ³•`YYTextDrawAttachment(...)`ï¼Œå¯¹äº`UIImage`å›¾ç‰‡çš„é™„ä»¶ï¼Œè¿˜èƒ½è®¾ç½®`UIViewContentMode`ï¼Œä¼šæ ¹æ®ä¸€å¼€å§‹è®¾ç½®çš„å ä½ run çš„å¤§å°åšå›¾ç‰‡å¡«å……å˜åŒ–ï¼Œç„¶åè°ƒç”¨ CoreGraphics API ç»˜åˆ¶å›¾ç‰‡ï¼š

```objc
CGImageRef ref = image.CGImage;
if (ref) {
CGContextSaveGState(context);
CGContextTranslateCTM(context, 0, CGRectGetMaxY(rect) + CGRectGetMinY(rect));
CGContextScaleCTM(context, 1, -1);
CGContextDrawImage(context, rect, ref);
CGContextRestoreGState(context);
}
```

è‹¥é™„ä»¶çš„ç±»å‹æ˜¯`UIView CALayer`ï¼Œé‚£åˆ†åˆ«å°±éœ€è¦é¢å¤–çš„ä¼ å…¥çˆ¶è§†å›¾ã€çˆ¶ layerï¼š`targetView  targetLayer`ï¼Œç„¶åçš„æ“ä½œå°±æ˜¯ç®€å•çš„å°†`UIView`æ·»åŠ åˆ°`targetView`ä¸Šæˆ–è€…å°†`CALayer`æ·»åŠ åˆ°`targetLayer `ä¸Šã€‚

### 2ã€ç‚¹å‡»é«˜äº®å®ç°

```objc
YYTextHighlightAttributeName : YYTextHighlight
```

`YYTextHighlight`åŒ…å«äº†å•å‡»å’Œé•¿æŒ‰çš„å›è°ƒï¼Œè¿˜åŒ…æ‹¬ä¸€äº›å±æ€§é…ç½®ã€‚åœ¨`YYLabel`ä¸­ï¼Œé€šè¿‡ä¸‹åˆ—æ–¹æ³•æ¥å†™è§¦å‘é€»è¾‘ï¼š

```objc
- (void)touchesBegan:(NSSet *)touches withEvent:(UIEvent *)event;
- (void)touchesMoved:(NSSet *)touches withEvent:(UIEvent *)event;
- (void)touchesEnded:(NSSet *)touches withEvent:(UIEvent *)event;
``` 

æ¶‰åŠåˆ°åˆ¤æ–­ç‚¹å‡»çš„`CGPoint`ç‚¹å¯¹åº”å¯Œæ–‡æœ¬ä¸­çš„å…·ä½“ä½ç½®ï¼Œæ‰€ä»¥æœ‰å¾ˆå¤šå¤æ‚çš„è®¡ç®—ï¼Œè¿™é‡Œä¸å±•å¼€äº†ã€‚

å½“æ‰¾åˆ°äº†åº”è¯¥è§¦å‘çš„`YYTextHighlight `ï¼Œæ›´æ¢å…·ä½“çš„`YYTextLine`ä¸ºé«˜äº®çŠ¶æ€çš„`YYTextLine`ï¼Œç„¶åé‡ç»˜ã€‚å½“æ‰‹æ¾å¼€æ—¶ï¼Œåˆ‡æ¢ä¼šå¸¸æ€ä¸‹çš„`YYTextLine`ã€‚

è¿™å°±æ˜¯ç‚¹å‡»é«˜äº®çš„å®ç°åŸç†ï¼Œå®é™…ä¸Šå°±æ˜¯æ›¿æ¢`YYTextLine`æ›´æ–°å¸ƒå±€ã€‚

# äº”ã€å¼‚æ­¥ç»˜åˆ¶

ä¸Šé¢ä»‹ç»äº†å‡ ç§ç‰¹æ®Šçš„è‡ªå®šä¹‰å¯Œæ–‡æœ¬å±æ€§ï¼Œå¯¹äºå…¶å®ƒçš„è‡ªå®šä¹‰å±æ€§ï¼ŒåŸºæœ¬ä¸Šéƒ½æ˜¯ä½¿ç”¨ CoreGraphics API ç»˜åˆ¶ï¼Œæ¯”å¦‚è¾¹æ¡†ã€é˜´å½±ç­‰ï¼Œå½“ç„¶ CoreText è‡ªå¸¦æœ‰å¾ˆå¤šæ•ˆæœï¼ŒYYText åšäº†ä¸€äº›æ”¹è‰¯å’Œæ‹“å±•ã€‚

å¯ä»¥çœ‹åˆ°ç»˜åˆ¶æ–¹æ³•éƒ½ä¼šå¸¦æœ‰ä¸€ä¸ªæ˜¯å¦å–æ¶ˆçš„ Blockï¼Œæ¯”å¦‚`static void YYTextDrawShadow(YYTextLayout *layout, CGContextRef context, CGSize size, CGPoint point, BOOL (^cancel)(void));`ã€‚è¿™ä¸ª`cancel`å°±æ˜¯ç”¨æ¥åˆ¤æ–­æ˜¯å¦éœ€è¦å–æ¶ˆæœ¬æ¬¡ç»˜åˆ¶ï¼Œè¿™æ ·å°±èƒ½åœ¨ä¸€æ¬¡ç»˜åˆ¶çš„ä»»æ„ä½ç½®ä¸­æ–­ï¼ŒåŠæ—¶çš„å–æ¶ˆæ— ç”¨çš„ç»˜åˆ¶ä»»åŠ¡ä»¥æé«˜æ•ˆç‡ã€‚

YYText å¯Œæ–‡æœ¬å¯ä»¥å¼‚æ­¥ç»˜åˆ¶ï¼Œä¹Ÿå¯ä»¥åœ¨ä¸»çº¿ç¨‹ç»˜åˆ¶ï¼Œåˆ›å»ºå¸ƒå±€ç±»åŠå…¶ç›¸å…³è®¡ç®—å¯ä»¥åœ¨ä»»æ„çº¿ç¨‹ï¼Œå¯ä»¥æ ¹æ®ä¸šåŠ¡éœ€æ±‚é€‰æ‹©é€‚åˆçš„ç­–ç•¥ã€‚

å…·ä½“å®ç°æœ‰äº›å¤æ‚ï¼Œæ‰€ä»¥å…³äºå¼‚æ­¥ç»˜åˆ¶çš„å…·ä½“åŸç†å¯ä»¥çœ‹ç¬”è€…ä¸“é—¨çš„ä¸€ç¯‡åšå®¢ï¼š

**YYAsyncLayer æºç å‰–æï¼šå¼‚æ­¥ç»˜åˆ¶**(https://www.jianshu.com/p/154451e4bd42)

YYAsyncLayer å°±æ˜¯ä» YYText é‡Œé¢æå–å‡ºæ¥çš„ç»„ä»¶ï¼Œæ ¸å¿ƒå°±æ˜¯ä¸€ä¸ªæ”¯æŒå¼‚æ­¥ç»˜åˆ¶çš„`CALayer`å­ç±»ï¼Œç›¸ä¿¡çœ‹å®Œ YYAsyncLayer çš„è§£æä¼šå¯¹å¼‚æ­¥ç»˜åˆ¶æœ‰è¾ƒæ·±çš„è®¤è¯†ã€‚

# åè¯­

YYText ç¡®å®è¿‡äºé‡é‡ï¼Œæœ¬æ–‡åªæ˜¯å¯¹åŸºç¡€éƒ¨åˆ†å–é‡ç‚¹åšäº†è§£æï¼Œé™¤æ­¤ä¹‹å¤–è¿˜æœ‰éå¸¸å¤šçš„è®¡ç®—å’Œé€»è¾‘ï¼Œæ„Ÿå…´è¶£å¯ä»¥è‡ªè¡Œç ”ç©¶ã€‚

ä»ä»£ç è´¨é‡æ¥çœ‹ï¼ŒYYText å‡ ä¹æ— å¯æŒ‘å‰”ï¼Œç»†èŠ‚å¤„ç†éå¸¸æ£’ï¼Œé€»è¾‘ä»£ç å¾ˆç²¾ç‚¼ï¼Œç¬”è€…å°è¯•è¿‡é‡å†™éƒ¨åˆ†é€»è¾‘ä»£ç ï¼Œå‘ç°ä¼˜åŒ–åŠå¤©åˆå›åˆ°äº†æºç çš„å†™æ³• ğŸ˜‚ï¼Œä¸å¾—ä¸ä½©æœä½œè€…çš„åŠŸåº•ã€‚

è‡³æ­¤ï¼Œç¬”è€…å·²ç»é˜…è¯»äº† YYKit å¤§éƒ¨åˆ†æºç ï¼Œæ›¾å¤šæ¬¡è¢«ä½œè€…çš„ä»£ç æŠ€å·§æ‰€æŠ˜æœï¼Œå‡ ä¹æ¯ä¸€å¥ä»£ç éƒ½ç»å¾—èµ·æ¨æ•²ï¼Œç¬”è€…ä¹Ÿæ›´åŠ æ·±åˆ»çš„ç†è§£äº†æ€§èƒ½ä¼˜åŒ–ï¼Œæ˜ç™½äº†ä¼˜åŒ–è¦ä»ç»†èŠ‚åšèµ·ã€‚

çªç„¶æƒ³èµ·äº†ç¬”è€…å’Œä¸€ä½å¥½å‹çš„ç¬‘æ¢—ã€‚æ¯é€¢ä½³æ—¶ï¼š

â€œè¿™ç¡®å®æ˜¯ä¸€ä¸ªéå¸¸å·§å¦™ä¸”ä»¤äººå…´å¥‹çš„æŠ€å·§â€ã€‚

### ç³»åˆ—æ–‡ç« 

* YYText æºç å‰–æï¼šCoreText ä¸å¼‚æ­¥ç»˜åˆ¶
	https://www.jianshu.com/p/b9ac1b5d8f01
* YYAsyncLayer æºç å‰–æï¼šå¼‚æ­¥ç»˜åˆ¶
	https://www.jianshu.com/p/154451e4bd42
* YYCache æºç å‰–æï¼šä¸€è§ˆäº®ç‚¹
	https://www.jianshu.com/p/408d4d37bcbd
* YYModel æºç å‰–æï¼šå…³æ³¨æ€§èƒ½
	https://www.jianshu.com/p/fe30e6bbc551
* YYImage æºç å‰–æï¼šå›¾ç‰‡å¤„ç†æŠ€å·§
	https://www.jianshu.com/p/43ac91be0cf4
* YYWebImage æºç å‰–æï¼šçº¿ç¨‹å¤„ç†ä¸ç¼“å­˜ç­–ç•¥
	https://www.jianshu.com/p/dd5537fa0caf


